<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מערכת עזרה למאבק בדחיינות</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="מאבק דחיינות">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwXzBfMSkiLz4KPHN0eWxlPi5zdGFye2ZpbGw6I2ZmZn0uc3RhcjI6ZXZlbnswJX0uc3RhcjI6b2RkeyZhbmltYXRpb246Ym91bmNlIDJzIGluZmluaXRlO30uYm91bmNle0BrZXlmcmFtZXMgYm91bmNle18wJSw0MCV7dHJhbnNmb3JtOnNjYWxlKDEpfTIwJXt0cmFuc2Zvcm06c2NhbGUoMS4xKX19fTwvc3R5bGU+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF8wXzEiIHgxPSIwIiB5MT0iMCIgeDI9IjE5MiIgeTI9IjE5MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjcwIiBmb250LWZhbWlseT0iQXJpYWwiPvCfjq88L3RleHQ+Cjx0ZXh0IHg9Ijk2IiB5PSIxNDAiIHRleXQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE2IiBmb250LWZhbWlseT0iQXJpYWwiPtedzt7eiNee15fXlSDXkNef15XXqDwvdGV4dD4KPC9zdmc+">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Manager -->
    <script src="supabase-manager.js"></script>
    
    <!-- Backup & Restore Manager -->
    <script src="backup-manager.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            direction: rtl;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .motivation-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .motivation-text {
            font-size: 1.3em;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .motivation-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .motivation-btn:hover {
            transform: scale(1.05);
        }

        .progress-section {
            margin: 25px 0;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 20px;
        }

        .task-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }

        .task-input input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .task-input input:focus {
            border-color: #667eea;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .add-btn:hover {
            background: #45a049;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            background: #f8f9fa;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-right: 5px solid #667eea;
        }

        .task-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
            border-right-color: #4CAF50;
        }

        .complete-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        /* 💾 CSS למערכת גיבוי ושחזור */
        .backup-section {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .backup-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .backup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .backup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .restore-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .restore-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .info-card {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .info-card p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .quiz-container {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .quiz-question {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .quiz-options {
            display: grid;
            gap: 15px;
        }

        .quiz-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
        }

        .quiz-option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .quiz-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .quiz-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .tip-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .tip-card:hover {
            transform: translateY(-5px);
        }

        .tip-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .tip-card p {
            color: #666;
            line-height: 1.5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .pomodoro-container {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .timer-display {
            margin: 30px 0;
        }

        .timer-circle {
            width: 250px;
            height: 250px;
            border: 8px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .timer-text {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .timer-mode {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .timer-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .timer-btn.start {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .timer-btn.pause {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .pomodoro-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .pomodoro-stat {
            text-align: center;
        }

        .pomodoro-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .setting-row input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }

        .level-display {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .level-info h3 {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .xp-bar {
            background: #e0e0e0;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin: 15px 0;
        }

        .xp-fill {
            background: linear-gradient(90deg, #ff9a9e, #fad0c4);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 20px;
        }

        .xp-text {
            color: #666;
            font-size: 1.1em;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .achievement-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .achievement-card.locked {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .achievement-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .achievement-desc {
            color: #666;
            font-size: 0.9em;
        }

        .detailed-stats {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-icon {
            font-size: 1.5em;
            margin-left: 15px;
        }

        .stat-desc {
            flex: 1;
            text-align: right;
            margin-right: 15px;
        }

        .stat-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
        }

        .journal-entry {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .mood-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .mood-btn {
            background: none;
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mood-btn:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .mood-btn.selected {
            border-color: #667eea;
            background: #667eea;
            transform: scale(1.1);
        }

        .selected-mood {
            text-align: center;
            font-size: 1.2em;
            color: #333;
            margin: 15px 0;
        }

        .reasons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .reason-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .reason-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .reason-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        #journalText {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            outline: none;
        }

        #journalText:focus {
            border-color: #667eea;
        }

        .save-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: transform 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
        }

        .journal-history {
            margin-top: 30px;
        }

        .journal-record {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-right: 5px solid #667eea;
        }

        .journal-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .journal-mood {
            margin: 10px 0;
        }

        .journal-reasons {
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }

        .journal-text {
            margin: 15px 0;
            line-height: 1.6;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 14px;
                margin: 5px;
            }
            
            .nav-tabs {
                gap: 5px;
            }
            
            .task-input {
                flex-direction: column;
            }
            
            .task-input input {
                margin-bottom: 10px;
            }
            
            .timer-circle {
                width: 200px;
                height: 200px;
            }
            
            .timer-text {
                font-size: 2.5em;
            }
            
            .pomodoro-stats {
                flex-direction: column;
                gap: 20px;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .tips-grid {
                grid-template-columns: 1fr;
            }
            
            .reasons-grid {
                grid-template-columns: 1fr;
            }
            
            .mood-selector {
                gap: 15px;
            }
            
            .mood-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            /* הסתר scrollbar במובייל */
            ::-webkit-scrollbar {
                display: none;
            }
        }
        
        /* תמיכה בנגיעות */
        .tab-btn,
        .motivation-btn,
        .timer-btn,
        .add-btn,
        .complete-btn,
        .delete-btn,
        .mood-btn,
        .reason-btn,
        .quiz-option {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            tap-highlight-color: transparent;
        }
        
        /* אפקטים לנגיעות */
        .tab-btn:active,
        .motivation-btn:active,
        .timer-btn:active,
        .add-btn:active {
            transform: scale(0.95);
        }
        
        /* PWA אייקון התקנה */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .install-prompt:hover {
            transform: translateX(-50%) translateY(-2px);
        }

        /* גרפים */
        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .chart-container {
            margin: 20px 0;
            text-align: center;
        }

        /* סנכרון */
        .sync-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .sync-status.online {
            background: #4CAF50;
            color: white;
        }

        .sync-status.offline {
            background: #f44336;
            color: white;
        }

        .sync-status.syncing {
            background: #ff9800;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sync-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .sync-info p {
            margin: 5px 0;
            color: #333;
        }

        /* כפתור דף הבית */
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .home-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .home-btn:active {
            transform: scale(0.95);
        }

        /* תפריט ניווט תחתון למובייל */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            display: none;
        }

        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .bottom-nav-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .bottom-nav-btn:hover,
        .bottom-nav-btn.active {
            background: rgba(102, 126, 234, 0.1);
            color: #4c63d2;
        }

        .bottom-nav-icon {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: block;
            }
            
            .container {
                padding-bottom: 80px;
            }
            
            .install-prompt {
                bottom: 90px;
            }
        }

        /* כפתור חזרה למעלה */
        .scroll-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        .scroll-top-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-top-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .scroll-top-btn {
                bottom: 90px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- כפתור דף הבית -->
    <button class="home-btn" onclick="goHome()" title="חזרה לדף הבית">🏠</button>
    
    <div class="container">
        <div class="header">
            <h1>🎯 מערכת עזרה למאבק בדחיינות</h1>
            <p>הכלים שתצטרך כדי להתגבר על הדחיינות ולהשיג את המטרות שלך</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('motivation')">💪 מוטיבציה</button>
            <button class="tab-btn" onclick="showTab('progress')">📊 מעקב התקדמות</button>
            <button class="tab-btn" onclick="showTab('pomodoro')">🍅 פומודורו</button>
            <button class="tab-btn" onclick="showTab('achievements')">🏆 הישגים</button>
            <button class="tab-btn" onclick="showTab('journal')">📝 יומן</button>
            <button class="tab-btn" onclick="showTab('tips')">💡 רעיונות לשיפור</button>
            <button class="tab-btn" onclick="showTab('quiz')">🧠 בדיקת דחיינות</button>
            <button class="tab-btn" onclick="showTab('settings')">⚙️ הגדרות</button>
            <button class="tab-btn" onclick="showTab('help')">📚 מידע לעזרה</button>
        </div>

        <!-- מוטיבציה -->
        <div class="tab-content active" id="motivation">
            <div class="motivation-card">
                <div class="motivation-text" id="motivationText">
                    "הדרך הטובה ביותר להתחיל היא להפסיק לדבר ולהתחיל לעשות"
                </div>
                <button class="motivation-btn" onclick="newMotivation()">💫 משפט מוטיבציה חדש</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="tasksCompleted">0</div>
                    <div class="stat-label">משימות הושלמו</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentStreak">0</div>
                    <div class="stat-label">רצף ימים רצופים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPoints">0</div>
                    <div class="stat-label">נקודות שנצברו</div>
                </div>
            </div>
        </div>

        <!-- טיימר פומודורו -->
        <div class="tab-content" id="pomodoro">
            <h2>🍅 טיימר פומודורו</h2>
            
            <div class="pomodoro-container">
                <div class="timer-display">
                    <div class="timer-circle">
                        <div class="timer-text" id="timerText">25:00</div>
                        <div class="timer-mode" id="timerMode">מוכן להתחלה</div>
                    </div>
                </div>
                
                <div class="timer-controls">
                    <button class="timer-btn start" id="startBtn" onclick="startPomodoro()">▶️ התחל</button>
                    <button class="timer-btn pause" id="pauseBtn" onclick="pausePomodoro()" style="display:none;">⏸️ השהה</button>
                    <button class="timer-btn reset" onclick="resetPomodoro()">🔄 איפוס</button>
                </div>
                
                <div class="pomodoro-stats">
                    <div class="pomodoro-stat">
                        <div class="stat-number" id="pomodoroCount">0</div>
                        <div class="stat-label">פומודורו היום</div>
                    </div>
                    <div class="pomodoro-stat">
                        <div class="stat-number" id="totalFocusTime">0</div>
                        <div class="stat-label">דקות מיקוד</div>
                    </div>
                </div>
                
                <div class="pomodoro-settings">
                    <h4>⚙️ הגדרות</h4>
                    <div class="setting-row">
                        <label>זמן עבודה (דקות):</label>
                        <input type="number" id="workTime" value="25" min="1" max="60">
                    </div>
                    <div class="setting-row">
                        <label>הפסקה קצרה (דקות):</label>
                        <input type="number" id="shortBreak" value="5" min="1" max="30">
                    </div>
                    <div class="setting-row">
                        <label>הפסקה ארוכה (דקות):</label>
                        <input type="number" id="longBreak" value="15" min="5" max="60">
                    </div>
                </div>
            </div>
        </div>

        <!-- הישגים -->
        <div class="tab-content" id="achievements">
            <h2>🏆 הישגים ורמות</h2>
            
            <div class="level-display">
                <div class="level-info">
                    <h3>רמה <span id="currentLevel">1</span></h3>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    </div>
                    <div class="xp-text"><span id="currentXP">0</span> / <span id="nextLevelXP">100</span> נקודות לרמה הבאה</div>
                </div>
            </div>
            
            <!-- גרף התקדמות שבועי -->
            <div class="info-card">
                <h3>📈 התקדמות השבוע</h3>
                <canvas id="weeklyChart" width="400" height="200"></canvas>
            </div>
            
            <!-- גרף פומודורו יומי -->
            <div class="info-card">
                <h3>🍅 פומודורו השבוע</h3>
                <canvas id="pomodoroChart" width="400" height="200"></canvas>
            </div>
            
            <div class="achievements-grid" id="achievementsGrid">
                <!-- הישגים יתווספו כאן דינמית -->
            </div>
            
            <div class="stats-detailed">
                <h3>📈 סטטיסטיקות מפורטות</h3>
                <div class="detailed-stats">
                    <div class="stat-item">
                        <span class="stat-icon">📅</span>
                        <span class="stat-desc">ימי פעילות רצופים</span>
                        <span class="stat-value" id="activeStreak">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">⏱️</span>
                        <span class="stat-desc">סה"כ שעות עבודה</span>
                        <span class="stat-value" id="totalHours">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🎯</span>
                        <span class="stat-desc">אחוז השלמת משימות</span>
                        <span class="stat-value" id="completionRate">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🔥</span>
                        <span class="stat-desc">הרצף הטוב ביותר</span>
                        <span class="stat-value" id="bestStreak">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">📊</span>
                        <span class="stat-desc">ממוצע משימות ליום</span>
                        <span class="stat-value" id="avgTasksPerDay">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🕒</span>
                        <span class="stat-desc">שעת היום הפרודוקטיבית ביותר</span>
                        <span class="stat-value" id="mostProductiveHour">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- יומן -->
        <div class="tab-content" id="journal">
            <h2>📝 יומן התמודדות עם דחיינות</h2>
            
            <div class="journal-entry">
                <h3>איך אתה מרגיש היום?</h3>
                <div class="mood-selector">
                    <button class="mood-btn" onclick="selectMood('😁', 'מעולה')" data-mood="excellent">😁</button>
                    <button class="mood-btn" onclick="selectMood('😊', 'טוב')" data-mood="good">😊</button>
                    <button class="mood-btn" onclick="selectMood('😐', 'בסדר')" data-mood="okay">😐</button>
                    <button class="mood-btn" onclick="selectMood('😔', 'לא כל כך טוב')" data-mood="bad">😔</button>
                    <button class="mood-btn" onclick="selectMood('😣', 'קשה')" data-mood="terrible">😣</button>
                </div>
                <div id="selectedMood" class="selected-mood"></div>
            </div>
            
            <div class="journal-entry">
                <h3>מה גרם לך לדחות משימות היום?</h3>
                <div class="reasons-grid">
                    <button class="reason-btn" onclick="toggleReason(this, 'פחד מכישלון')">😨 פחד מכישלון</button>
                    <button class="reason-btn" onclick="toggleReason(this, 'המשימה משעממת')">😴 המשימה משעממת</button>
                    <button class="reason-btn" onclick="toggleReason(this, 'הרגשת העמסה')">🤯 הרגשת העמסה</button>
                    <button class="reason-btn" onclick="toggleReason(this, 'הסחות דעת')">📱 הסחות דעת</button>
                    <button class="reason-btn" onclick="toggleReason(this, 'חוסר מוטיבציה')">😑 חוסר מוטיבציה</button>
                    <button class="reason-btn" onclick="toggleReason(this, 'פרפקציוניזם')">🔍 פרפקציוניזם</button>
                </div>
            </div>
            
            <div class="journal-entry">
                <h3>מחשבות ותובנות</h3>
                <textarea id="journalText" placeholder="כתב על המחשבות שלך, האתגרים שהיו לך היום, או דברים שעזרו לך להתמודד עם דחיינות..."></textarea>
                <button class="save-btn" onclick="saveJournalEntry()">💾 שמור רשומה</button>
            </div>
            
            <div class="journal-history">
                <h3>📚 רשומות קודמות</h3>
                <div id="journalHistory">
                    <!-- רשומות יומן יופיעו כאן -->
                </div>
            </div>
        </div>
        <div class="tab-content" id="progress">
            <h2>📈 מעקב אחרי המשימות שלך</h2>
            
            <div class="task-input">
                <input type="text" id="taskInput" placeholder="הכנס משימה חדשה..." onkeypress="handleEnter(event)">
                <button class="add-btn" onclick="addTask()">➕ הוסף משימה</button>
            </div>

            <div class="progress-section">
                <h3>התקדמות יומית</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
                </div>
                <p id="progressText">0% הושלם היום</p>
            </div>

            <ul class="task-list" id="taskList">
                <!-- משימות יתווספו כאן דינמית -->
            </ul>
        </div>

        <!-- רעיונות לשיפור -->
        <div class="tab-content" id="tips">
            <h2>💡 רעיונות וטכניקות לשיפור</h2>
            
            <div class="tips-grid">
                <div class="tip-card">
                    <h4>🍅 טכניקת הפומודורו</h4>
                    <p>עבוד 25 דקות, קח הפסקה של 5 דקות. חזור על התהליך. זו דרך מעולה לשמור על מיקוד ולמנוע שחיקה.</p>
                </div>
                
                <div class="tip-card">
                    <h4>🎯 משימות קטנות</h4>
                    <p>חלק משימות גדולות למשימות קטנות יותר. במקום "לכתוב מאמר", תכתוב "לחקור נושא", "לכתוב מבוא", "לערוך פסקה ראשונה".</p>
                </div>
                
                <div class="tip-card">
                    <h4>⏰ כלל 2 הדקות</h4>
                    <p>אם משימה לוקחת פחות מ-2 דקות - עשה אותה מיד! זה ימנע הצטברות של משימות קטנות.</p>
                </div>
                
                <div class="tip-card">
                    <h4>🚀 התחל במשהו קל</h4>
                    <p>התחל את היום במשימה קלה שתיתן לך תחושת הישג. זה יבנה לך מומנטום ליום.</p>
                </div>
                
                <div class="tip-card">
                    <h4>📱 הסח דעת</h4>
                    <p>הרחק מכשירים מסיחי דעת. שים את הטלפון בחדר אחר או השתמש באפליקציות חסימה.</p>
                </div>
                
                <div class="tip-card">
                    <h4>🎉 תגמל את עצמך</h4>
                    <p>קבע פרסים לעצמך אחרי השלמת משימות. זה יכול להיות משהו קטן כמו פרח שוקולד או פרק בסדרה.</p>
                </div>
            </div>
        </div>

        <!-- בדיקת דחיינות -->
        <div class="tab-content" id="quiz">
            <h2>🧠 בדיקת רמת הדחיינות שלך</h2>
            
            <div class="quiz-container">
                <div class="quiz-question" id="quizQuestion">
                    כמה פעמים בשבוע אתה דוחה משימות חשובות?
                </div>
                
                <div class="quiz-options" id="quizOptions">
                    <div class="quiz-option" onclick="selectOption(0)">כמעט אף פעם</div>
                    <div class="quiz-option" onclick="selectOption(1)">פעם-פעמיים בשבוע</div>
                    <div class="quiz-option" onclick="selectOption(2)">מספר פעמים בשבוע</div>
                    <div class="quiz-option" onclick="selectOption(3)">כמעט כל יום</div>
                </div>
                
                <div class="quiz-result" id="quizResult" style="display: none;"></div>
            </div>
        </div>

        <!-- הגדרות והתראות -->
        <div class="tab-content" id="settings">
            <h2>⚙️ הגדרות והתראות</h2>
            
            <div class="info-card">
                <h3>🔔 הגדרות התראות</h3>
                <div class="setting-row">
                    <label>אפשר התראות:</label>
                    <input type="checkbox" id="enableNotifications" onchange="toggleNotifications()">
                </div>
                <div class="setting-row">
                    <label>תזכורת פומודורו (דקות):</label>
                    <input type="number" id="pomodoroReminder" value="30" min="5" max="120">
                </div>
                <div class="setting-row">
                    <label>תזכורת יומית (שעה):</label>
                    <input type="time" id="dailyReminder" value="09:00">
                </div>
                <div class="setting-row">
                    <label>תזכורת הפסקה (דקות עבודה רצופה):</label>
                    <input type="number" id="breakReminder" value="60" min="15" max="180">
                </div>
                <button class="save-btn" onclick="saveNotificationSettings()">💾 שמור הגדרות</button>
            </div>
            
            <div class="info-card">
                <h3>🔄 סנכרון בין מכשירים</h3>
                <div class="setting-row">
                    <label>מצב סנכרון:</label>
                    <span id="syncStatus" class="sync-status offline">לא מחובר</span>
                </div>
                <div class="setting-row">
                    <input type="email" id="userEmail" placeholder="כתובת אימייל לסנכרון" style="flex: 1; margin-left: 10px;">
                    <button class="motivation-btn" onclick="loginToSync()" id="syncLoginBtn">התחבר</button>
                </div>
                <div class="setting-row">
                    <button class="motivation-btn" onclick="syncNow()" id="syncNowBtn" disabled>🔄 סנכרן עכשיו</button>
                    <button class="delete-btn" onclick="disconnectSync()" id="disconnectBtn" disabled>התנתק</button>
                </div>
                <div class="sync-info">
                    <p><strong>איך זה עובד:</strong></p>
                    <p>• הכנס את אותו אימייל בכל המכשירים שלך</p>
                    <p>• הנתונים יסתנכרנו אוטומטית כל 2 דקות</p>
                    <p>• עובד בין טלפון, מחשב וטאבלט</p>
                    <p>• הנתונים מוצפנים ומאובטחים</p>
                </div>
            </div>
            
            <div class="info-card">
                <h3>📊 הגדרות נתונים</h3>
                <div class="setting-row">
                    <label>🌐 ספק סינכרון ענן:</label>
                    <select id="cloudProvider" onchange="changeCloudProvider()">
                        <option value="firebase">Firebase (ברירת מחדל)</option>
                        <option value="supabase">Supabase (חדש!)</option>
                        <option value="local">רק מקומי (בלי ענן)</option>
                    </select>
                </div>
                <div id="cloudStatus" class="setting-row">
                    <span id="cloudConnectionStatus">🔄 בודק חיבור...</span>
                </div>
                <div class="setting-row">
                    <button class="motivation-btn" onclick="testCloudConnection()">🔍 בדק חיבור ענן</button>
                    <button class="motivation-btn" onclick="syncNow()">🔄 סנכרן עכשיו</button>
                </div>
                
                <!-- מערכת גיבוי ושחזור מתקדמת -->
                <div class="backup-section">
                    <h4>💾 גיבוי ושחזור מתקדם</h4>
                    <div class="setting-row">
                        <button class="backup-btn" onclick="createBackup('full')">📦 גיבוי מלא</button>
                        <button class="backup-btn" onclick="createBackup('tasks')">📝 גיבוי משימות</button>
                        <button class="backup-btn" onclick="createBackup('settings')">⚙️ גיבוי הגדרות</button>
                    </div>
                    <div class="setting-row">
                        <button class="restore-btn" onclick="restoreBackup()">🔄 שחזור מקובץ</button>
                        <button class="restore-btn" onclick="restoreAutoBackup()">📅 שחזור גיבוי אוטומטי</button>
                    </div>
                    <div class="setting-row" style="font-size: 12px; color: #666;">
                        <span id="lastBackupInfo">📅 גיבוי אוטומטי יומי פעיל</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <button class="motivation-btn" onclick="exportData()">📤 ייצא נתונים (פשוט)</button>
                    <button class="motivation-btn" onclick="importData()">📥 ייבא נתונים (פשוט)</button>
                </div>
                <div class="setting-row">
                    <button class="delete-btn" onclick="resetAllData()">🗑️ אפס את כל הנתונים</button>
                </div>
            </div>
            
            <div class="info-card">
                <h3>🎨 הגדרות תצוגה</h3>
                <div class="setting-row">
                    <label>ערכת צבעים:</label>
                    <select id="colorTheme" onchange="changeTheme()">
                        <option value="default">ברירת מחדל</option>
                        <option value="dark">מצב לילה</option>
                        <option value="nature">טבע</option>
                        <option value="ocean">אוקיינוס</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label>גודל גופן:</label>
                    <select id="fontSize" onchange="changeFontSize()">
                        <option value="small">קטן</option>
                        <option value="medium" selected>בינוני</option>
                        <option value="large">גדול</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- מידע לעזרה -->
        <div class="tab-content" id="help">
            <h2>📚 מידע ועזרה נוספת</h2>
            
            <div class="info-card">
                <h3>🤔 מה זה דחיינות?</h3>
                <p>דחיינות היא הנטייה לדחות משימות חשובות למועד מאוחר יותר, בדרך כלל תוך עיסוק בפעילויות פחות חשובות או נעימות יותר.</p>
                <p>זהו מנגנון הגנה נפשי שמטרתו להימנע מרגשות שליליים כמו חרדה, פחד מכישלון או תחושת העמסה.</p>
            </div>
            
            <div class="info-card">
                <h3>🧪 הסיבות לדחיינות</h3>
                <p><strong>פחד מכישלון:</strong> החשש שהביצועים לא יהיו מושלמים גורם לדחיית ההתחלה.</p>
                <p><strong>פרפקציוניזם:</strong> הרצון לעשות הכל מושלם יכול לשתק ולמנוע התחלה.</p>
                <p><strong>חוסר מוטיבציה:</strong> כשהמשימה לא נראית מעניינת או רלוונטית.</p>
                <p><strong>הצפה:</strong> כשהמשימה נראית גדולה מדי ומורכבת מדי.</p>
            </div>
            
            <div class="info-card">
                <h3>💊 אסטרטגיות התמודדות</h3>
                <p><strong>חלוקה למטלות קטנות:</strong> פרק משימות גדולות לחלקים קטנים וניתנים לביצוע.</p>
                <p><strong>קביעת דדליינים:</strong> קבע תאריכי יעד ריאליים ועמוד בהם.</p>
                <p><strong>מערכת תגמולים:</strong> תגמל את עצמך אחרי השלמת משימות.</p>
                <p><strong>סביבת עבודה:</strong> צור סביבה נטולת הסחות דעת.</p>
                <p><strong>תמיכה חברתית:</strong> שתף אחרים במטרות שלך לאחריותיות.</p>
            </div>
            
            <div class="info-card">
                <h3>🆘 מתי לפנות לעזרה מקצועית</h3>
                <p>אם הדחיינות פוגעת משמעותית באיכות החיים, בעבודה, בלימודים או ביחסים, מומלץ לפנות לייעוץ פסיכולוגי.</p>
                <p>מטפל מקצועי יכול לעזור לזהות את השורשים העמוקים של הדחיינות ולפתח אסטרטגיות התמודדות מותאמות אישית.</p>
            </div>
            
            <div class="info-card">
                <h3>⌨️ מקשי קיצור</h3>
                <p><strong>H</strong> - חזרה לדף הבית</p>
                <p><strong>Alt + 1-5</strong> - מעבר בין טאבים (בית, משימות, פומודורו, סטטיסטיקות, הגדרות)</p>
                <p><strong>Enter</strong> - הוספת משימה חדשה (בטאב משימות)</p>
                <p><strong>רווח</strong> - התחלה/השהיית פומודורו (בטאב פומודורו)</p>
                <p><strong>ESC</strong> - חזרה לדף הבית</p>
            </div>
        </div>
    </div>

    <!-- כפתור התקנת אפליקציה -->
    <button class="install-prompt" id="installBtn" onclick="installApp()">
        📱 התקן אפליקציה
    </button>

    <!-- כפתור חזרה למעלה -->
    <button class="scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()">↑</button>

    <!-- תפריט ניווט תחתון למובייל -->
    <div class="bottom-nav">
        <div class="bottom-nav-items">
            <button class="bottom-nav-btn active" onclick="showTab('motivation'); setActiveBottomNav(this)">
                <span class="bottom-nav-icon">💪</span>
                <span>בית</span>
            </button>
            <button class="bottom-nav-btn" onclick="showTab('progress'); setActiveBottomNav(this)">
                <span class="bottom-nav-icon">📊</span>
                <span>משימות</span>
            </button>
            <button class="bottom-nav-btn" onclick="showTab('pomodoro'); setActiveBottomNav(this)">
                <span class="bottom-nav-icon">🍅</span>
                <span>פומודורו</span>
            </button>
            <button class="bottom-nav-btn" onclick="showTab('achievements'); setActiveBottomNav(this)">
                <span class="bottom-nav-icon">🏆</span>
                <span>סטטיסטיקות</span>
            </button>
            <button class="bottom-nav-btn" onclick="showTab('settings'); setActiveBottomNav(this)">
                <span class="bottom-nav-icon">⚙️</span>
                <span>הגדרות</span>
            </button>
        </div>
    </div>

    <script>
        // משתנים גלובליים
        let tasks = [];
        let completedTasks = 0;
        let currentStreak = 0;
        let totalPoints = 0;
        let currentQuizQuestion = 0;
        let quizScore = 0;

        // משתנים פומודורו
        let pomodoroTimer = null;
        let pomodoroTime = 25 * 60; // 25 דקות בשניות
        let isPomodoroPaused = false;
        let pomodoroCount = 0;
        let totalFocusTime = 0;
        let currentPomodoroMode = 'work'; // work, shortBreak, longBreak

        // משתנים הגדרות
        let notificationSettings = {
            enabled: false,
            pomodoroReminder: 30,
            dailyReminder: '09:00',
            breakReminder: 60
        };
        let workStartTime = null;
        let notificationInterval = null;

        // משתנים סנכרון
        let syncEnabled = false;
        let syncUser = null;
        let syncInterval = null;
        let lastSyncTime = null;

        // Firebase Configuration (דוגמה - תצטרך להחליף בפרטים שלך)
        const firebaseConfig = {
            apiKey: "demo-key",
            authDomain: "procrastination-app-demo.firebaseapp.com",
            projectId: "procrastination-app-demo",
            storageBucket: "procrastination-app-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // אתחול Firebase (רק אם Firebase זמין)
        let db = null;
        let auth = null;

        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    console.log('Firebase initialized successfully');
                    return true;
                }
            } catch (error) {
                console.log('Firebase not available, using local storage only');
            }
            return false;
        }

        // פונקציות התראות
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('התראות הופעלו!', 'תקבל תזכורות שיעזרו לך להישאר פרודוקטיבי');
                    }
                });
            }
        }

        function showNotification(title, body, icon = '🎯') {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+Cjx0ZXh0IHg9IjEyIiB5PSIxOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTYiIGZvbnQtZmFtaWx5PSJBcmlhbCI+8J+OrzwvdGV4dD4KPC9zdmc+Cjwvc3ZnPg==',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzYiIGN5PSIzNiIgcj0iMzYiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+Cjx0ZXh0IHg9IjEyIiB5PSIxOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTYiIGZvbnQtZmFtaWx5PSJBcmlhbCI+8J+OrzwvdGV4dD4KPC9zdmc+Cjwvc3ZnPg==',
                    vibrate: [200, 100, 200],
                    requireInteraction: false
                });

                // סגור התראה אחרי 5 שניות
                setTimeout(() => notification.close(), 5000);
            }
        }

        function toggleNotifications() {
            const checkbox = document.getElementById('enableNotifications');
            notificationSettings.enabled = checkbox.checked;
            
            if (notificationSettings.enabled) {
                requestNotificationPermission();
                startNotificationTimer();
            } else {
                stopNotificationTimer();
            }
            
            saveNotificationSettings();
        }

        function startNotificationTimer() {
            if (notificationInterval) clearInterval(notificationInterval);
            
            notificationInterval = setInterval(() => {
                if (notificationSettings.enabled) {
                    const now = new Date();
                    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                       now.getMinutes().toString().padStart(2, '0');
                    
                    // תזכורת יומית
                    if (currentTime === notificationSettings.dailyReminder) {
                        showNotification('תזכורת יומית', 'זמן לבדוק את המשימות שלך ולהתחיל את היום בפרודוקטיביות!');
                    }
                    
                    // תזכורת הפסקה
                    if (workStartTime && 
                        (now - workStartTime) >= notificationSettings.breakReminder * 60 * 1000) {
                        showNotification('זמן להפסקה!', 'עבדת קשה - קח הפסקה קצרה לרענון');
                        workStartTime = now; // איפוס הטיימר
                    }
                }
            }, 60000); // בדיקה כל דקה
        }

        function stopNotificationTimer() {
            if (notificationInterval) {
                clearInterval(notificationInterval);
                notificationInterval = null;
            }
        }

        function saveNotificationSettings() {
            notificationSettings.pomodoroReminder = parseInt(document.getElementById('pomodoroReminder').value);
            notificationSettings.dailyReminder = document.getElementById('dailyReminder').value;
            notificationSettings.breakReminder = parseInt(document.getElementById('breakReminder').value);
            
            localStorage.setItem('notification_settings', JSON.stringify(notificationSettings));
            showNotification('הגדרות נשמרו', 'ההגדרות שלך נשמרו בהצלחה');
        }

        function loadNotificationSettings() {
            const saved = localStorage.getItem('notification_settings');
            if (saved) {
                notificationSettings = JSON.parse(saved);
                
                document.getElementById('enableNotifications').checked = notificationSettings.enabled;
                document.getElementById('pomodoroReminder').value = notificationSettings.pomodoroReminder;
                document.getElementById('dailyReminder').value = notificationSettings.dailyReminder;
                document.getElementById('breakReminder').value = notificationSettings.breakReminder;
                
                if (notificationSettings.enabled) {
                    startNotificationTimer();
                }
            }
        }

        // פונקציות ייצוא/ייבוא נתונים
        function exportData() {
            const data = {
                tasks: tasks,
                stats: { completedTasks, currentStreak, totalPoints },
                journal: journalEntries,
                pomodoro: { pomodoroCount, totalFocusTime },
                settings: notificationSettings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `procrastination-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('נתונים יוצאו', 'הנתונים שלך נשמרו לקובץ');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // טעינת נתונים
                            if (data.tasks) tasks = data.tasks;
                            if (data.stats) {
                                completedTasks = data.stats.completedTasks || 0;
                                currentStreak = data.stats.currentStreak || 0;
                                totalPoints = data.stats.totalPoints || 0;
                            }
                            if (data.journal) journalEntries = data.journal;
                            if (data.pomodoro) {
                                pomodoroCount = data.pomodoro.pomodoroCount || 0;
                                totalFocusTime = data.pomodoro.totalFocusTime || 0;
                            }
                            if (data.settings) notificationSettings = data.settings;
                            
                            // שמירה ועדכון תצוגה
                            saveData();
                            updateStats();
                            renderTasks();
                            updateProgress();
                            displayJournalHistory();
                            updatePomodoroStats();
                            loadNotificationSettings();
                            
                            showNotification('נתונים יובאו', 'הנתונים שלך טועמו בהצלחה');
                        } catch (error) {
                            alert('שגיאה בקריאת הקובץ. אנא ודא שהקובץ תקין.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        function resetAllData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו לא ניתנת לביטול.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // 🌐 פונקציות ניהול ספק ענן
        let currentCloudProvider = localStorage.getItem('cloudProvider') || 'firebase';
        
        function changeCloudProvider() {
            const select = document.getElementById('cloudProvider');
            const newProvider = select.value;
            
            if (newProvider !== currentCloudProvider) {
                if (confirm(`האם להעבור ל-${newProvider}? הנתונים יסונכרנו אוטומטית.`)) {
                    currentCloudProvider = newProvider;
                    localStorage.setItem('cloudProvider', newProvider);
                    
                    // עדכון סטטוס
                    updateCloudStatus('🔄 מעבר בין ספקי ענן...');
                    
                    // ביצוע סינכרון
                    setTimeout(() => {
                        syncNow();
                    }, 1000);
                    
                    showNotification('ספק ענן שונה', `עברת ל-${newProvider}. הנתונים יסונכרנו אוטומטית.`);
                } else {
                    // החזרת הבחירה הקודמת
                    select.value = currentCloudProvider;
                }
            }
        }
        
        async function testCloudConnection() {
            updateCloudStatus('🔄 בודק חיבור...');
            
            try {
                let isConnected = false;
                
                if (currentCloudProvider === 'firebase') {
                    // בדיקת Firebase
                    isConnected = typeof firebase !== 'undefined' && firebase.apps.length > 0;
                } else if (currentCloudProvider === 'supabase') {
                    // בדיקת Supabase
                    if (window.supabaseManager) {
                        isConnected = await window.supabaseManager.testConnection();
                    }
                } else {
                    // מצב מקומי
                    isConnected = true;
                }
                
                if (isConnected) {
                    updateCloudStatus(`✅ חיבור ל-${currentCloudProvider} תקין`);
                    showNotification('חיבור תקין', `חיבור ל-${currentCloudProvider} עובד מצוין!`);
                } else {
                    updateCloudStatus(`❌ בעיה בחיבור ל-${currentCloudProvider}`);
                    showNotification('בעיה בחיבור', `לא ניתן להתחבר ל-${currentCloudProvider}`);
                }
                
            } catch (error) {
                console.error('שגיאה בבדיקת חיבור:', error);
                updateCloudStatus(`❌ שגיאה בבדיקת חיבור`);
            }
        }
        
        function updateCloudStatus(message) {
            const statusElement = document.getElementById('cloudConnectionStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        async function syncNow() {
            updateCloudStatus('🔄 מסנכרן...');
            
            try {
                const userData = {
                    tasks: tasks,
                    stats: { completedTasks, currentStreak, totalPoints },
                    journal: journalEntries,
                    pomodoro: { pomodoroCount, totalFocusTime },
                    settings: notificationSettings,
                    lastSyncTime: new Date().toISOString()
                };
                
                if (currentCloudProvider === 'firebase' && firebaseInitialized) {
                    // סינכרון עם Firebase
                    const user = firebase.auth().currentUser;
                    if (user) {
                        await firebase.firestore().collection('users').doc(user.uid).set(userData);
                        updateCloudStatus('✅ סינכרון Firebase הושלם');
                        showNotification('סינכרון הושלם', 'הנתונים נשמרו ב-Firebase');
                    } else {
                        updateCloudStatus('⚠️ נדרשת התחברות ל-Firebase');
                    }
                } else if (currentCloudProvider === 'supabase' && window.supabaseManager) {
                    // סינכרון עם Supabase
                    const userId = localStorage.getItem('userId') || 'anonymous-' + Date.now();
                    const result = await window.supabaseManager.syncUserData(userId, userData);
                    
                    if (result.success) {
                        updateCloudStatus('✅ סינכרון Supabase הושלם');
                        showNotification('סינכרון הושלם', 'הנתונים נשמרו ב-Supabase');
                        
                        // עדכון נתונים מקומיים אם יש שינויים
                        if (result.data) {
                            updateLocalDataFromCloud(result.data);
                        }
                    } else {
                        updateCloudStatus('❌ שגיאה בסינכרון Supabase');
                        showNotification('שגיאה בסינכרון', 'לא ניתן לסנכרן עם Supabase');
                    }
                } else if (currentCloudProvider === 'local') {
                    // שמירה מקומית בלבד
                    saveData();
                    updateCloudStatus('💾 נשמר מקומית בלבד');
                    showNotification('נשמר מקומית', 'הנתונים נשמרו רק במחשב זה');
                }
                
            } catch (error) {
                console.error('שגיאה בסינכרון:', error);
                updateCloudStatus('❌ שגיאה בסינכרון');
                showNotification('שגיאה', 'לא ניתן לסנכרן את הנתונים');
            }
        }
        
        function updateLocalDataFromCloud(cloudData) {
            // עדכון נתונים מקומיים מהענן (רק אם יש שינויים)
            let updated = false;
            
            if (cloudData.tasks && JSON.stringify(cloudData.tasks) !== JSON.stringify(tasks)) {
                tasks = cloudData.tasks;
                renderTasks();
                updated = true;
            }
            
            if (cloudData.stats) {
                if (cloudData.stats.completedTasks !== completedTasks || 
                    cloudData.stats.currentStreak !== currentStreak || 
                    cloudData.stats.totalPoints !== totalPoints) {
                    completedTasks = cloudData.stats.completedTasks || 0;
                    currentStreak = cloudData.stats.currentStreak || 0;
                    totalPoints = cloudData.stats.totalPoints || 0;
                    updateStats();
                    updated = true;
                }
            }
            
            if (cloudData.journal && JSON.stringify(cloudData.journal) !== JSON.stringify(journalEntries)) {
                journalEntries = cloudData.journal;
                displayJournalHistory();
                updated = true;
            }
            
            if (cloudData.pomodoro) {
                if (cloudData.pomodoro.pomodoroCount !== pomodoroCount || 
                    cloudData.pomodoro.totalFocusTime !== totalFocusTime) {
                    pomodoroCount = cloudData.pomodoro.pomodoroCount || 0;
                    totalFocusTime = cloudData.pomodoro.totalFocusTime || 0;
                    updatePomodoroStats();
                    updated = true;
                }
            }
            
            if (updated) {
                saveData(); // שמירה מקומית של השינויים
                updateProgress();
                console.log('✅ נתונים מקומיים עודכנו מהענן');
            }
        }

        // 💾 פונקציות גיבוי ושחזור מתקדמות
        async function createBackup(type = 'full') {
            try {
                console.log(`📦 יוצר גיבוי ${type}...`);
                updateLastBackupInfo(`🔄 יוצר גיבוי ${type}...`);
                
                const result = await window.backupManager.exportBackupFile(type);
                
                if (result.success) {
                    updateLastBackupInfo(`✅ גיבוי ${type} נוצר: ${result.filename}`);
                    showNotification('גיבוי נוצר', `גיבוי ${type} נשמר בהצלחה`);
                } else {
                    updateLastBackupInfo(`❌ שגיאה ביצירת גיבוי ${type}`);
                    showNotification('שגיאה בגיבוי', result.error || 'לא ניתן ליצור גיבוי');
                }
            } catch (error) {
                console.error('❌ שגיאה ביצירת גיבוי:', error);
                updateLastBackupInfo(`❌ שגיאה ביצירת גיבוי`);
                showNotification('שגיאה', 'לא ניתן ליצור גיבוי');
            }
        }

        async function restoreBackup() {
            try {
                console.log('🔄 מתחיל תהליך שחזור...');
                updateLastBackupInfo('🔄 בוחר קובץ לשחזור...');
                
                const result = await window.backupManager.restoreFromFile();
                
                if (result.success) {
                    updateLastBackupInfo(`✅ שחזור הושלם: ${result.restored?.join(', ') || 'הכל'}`);
                    showNotification('שחזור הושלם', result.message || 'הנתונים שוחזרו בהצלחה');
                    
                    // רענון הממשק
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    updateLastBackupInfo(`❌ שגיאה בשחזור`);
                    showNotification('שגיאה בשחזור', result.error || 'לא ניתן לשחזר את הנתונים');
                }
            } catch (error) {
                console.error('❌ שגיאה בשחזור:', error);
                updateLastBackupInfo(`❌ שגיאה בשחזור`);
                showNotification('שגיאה', 'לא ניתן לבצע שחזור');
            }
        }

        async function restoreAutoBackup() {
            try {
                console.log('🔄 משחזר מגיבוי אוטומטי...');
                updateLastBackupInfo('🔄 משחזר מגיבוי אוטומטי...');
                
                const result = await window.backupManager.restoreFromAutoBackup();
                
                if (result.success) {
                    updateLastBackupInfo(`✅ שחזור אוטומטי הושלם`);
                    showNotification('שחזור הושלם', 'הנתונים שוחזרו מגיבוי אוטומטי');
                    
                    // רענון הממשק
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    updateLastBackupInfo(`❌ אין גיבוי אוטומטי זמין`);
                    showNotification('אין גיבוי זמין', result.error || 'לא נמצא גיבוי אוטומטי');
                }
            } catch (error) {
                console.error('❌ שגיאה בשחזור אוטומטי:', error);
                updateLastBackupInfo(`❌ שגיאה בשחזור אוטומטי`);
                showNotification('שגיאה', 'לא ניתן לשחזר מגיבוי אוטומטי');
            }
        }

        function updateLastBackupInfo(message) {
            const infoElement = document.getElementById('lastBackupInfo');
            if (infoElement) {
                infoElement.textContent = message;
            }
        }

        // עדכון מידע גיבוי אוטומטי בטעינת דף
        function updateAutoBackupStatus() {
            const lastBackup = localStorage.getItem('lastAutoBackup');
            if (lastBackup) {
                const backupDate = new Date(lastBackup);
                const today = new Date();
                const diffTime = Math.abs(today - backupDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 1) {
                    updateLastBackupInfo(`📅 גיבוי אוטומטי אחרון: היום`);
                } else {
                    updateLastBackupInfo(`📅 גיבוי אוטומטי אחרון: לפני ${diffDays} ימים`);
                }
            } else {
                updateLastBackupInfo(`📅 גיבוי אוטומטי יומי פעיל`);
            }
        }

        // פונקציות עיצוב
        function changeTheme() {
            const theme = document.getElementById('colorTheme').value;
            const root = document.documentElement;
            
            switch(theme) {
                case 'dark':
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)');
                    break;
                case 'nature':
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)');
                    break;
                case 'ocean':
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                    break;
                default:
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
            }
            
            localStorage.setItem('selected_theme', theme);
        }

        function changeFontSize() {
            const size = document.getElementById('fontSize').value;
            const root = document.documentElement;
            
            switch(size) {
                case 'small':
                    root.style.fontSize = '14px';
                    break;
                case 'large':
                    root.style.fontSize = '18px';
                    break;
                default:
                    root.style.fontSize = '16px';
            }
            
            localStorage.setItem('selected_font_size', size);
        }

        // פונקציות סנכרון
        function updateSyncStatus(status, text) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.className = `sync-status ${status}`;
                statusElement.textContent = text;
            }
        }

        function loginToSync() {
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                alert('אנא הכנס כתובת אימייל');
                return;
            }

            if (!isValidEmail(email)) {
                alert('אנא הכנס כתובת אימייל תקינה');
                return;
            }

            // במקום Firebase אמיתי, נשתמש בפתרון פשוט יותר
            syncUser = email;
            syncEnabled = true;
            
            localStorage.setItem('sync_user', email);
            localStorage.setItem('sync_enabled', 'true');
            
            updateSyncStatus('online', 'מחובר');
            updateSyncButtons(true);
            
            // התחלת סנכרון אוטומטי
            startAutoSync();
            
            showNotification('סנכרון הופעל!', `מחובר כ-${email}`);
        }

        function disconnectSync() {
            syncEnabled = false;
            syncUser = null;
            
            localStorage.removeItem('sync_user');
            localStorage.removeItem('sync_enabled');
            
            updateSyncStatus('offline', 'לא מחובר');
            updateSyncButtons(false);
            
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            document.getElementById('userEmail').value = '';
            showNotification('סנכרון הופסק', 'התנתקת בהצלחה');
        }

        function updateSyncButtons(connected) {
            const loginBtn = document.getElementById('syncLoginBtn');
            const syncBtn = document.getElementById('syncNowBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (loginBtn) loginBtn.disabled = connected;
            if (syncBtn) syncBtn.disabled = !connected;
            if (disconnectBtn) disconnectBtn.disabled = !connected;
            
            if (loginBtn) loginBtn.textContent = connected ? 'מחובר' : 'התחבר';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function syncNow() {
            if (!syncEnabled || !syncUser) {
                alert('אנא התחבר תחילה לסנכרון');
                return;
            }
            
            updateSyncStatus('syncing', 'מסנכרן...');
            
            // סנכרון נתונים
            saveToCloudStorage();
            loadFromCloudStorage();
            
            setTimeout(() => {
                updateSyncStatus('online', 'מחובר');
                lastSyncTime = new Date();
                showNotification('סנכרון הושלם!', 'הנתונים עודכנו בכל המכשירים');
            }, 2000);
        }

        function startAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // סנכרון אוטומטי כל 2 דקות
            syncInterval = setInterval(() => {
                if (syncEnabled && navigator.onLine) {
                    autoSyncData();
                }
            }, 2 * 60 * 1000);
        }

        function autoSyncData() {
            if (!syncEnabled) return;
            
            const currentData = getAllUserData();
            const cloudKey = `procrastination_data_${syncUser}`;
            
            // שמירה לחנות מקומית (דמוי ענן)
            const existingData = localStorage.getItem(cloudKey);
            const lastModified = localStorage.getItem(`${cloudKey}_modified`);
            const currentTime = Date.now();
            
            // בדיקה אם יש עדכון מהענן
            if (existingData && lastModified) {
                const cloudData = JSON.parse(existingData);
                const cloudTime = parseInt(lastModified);
                
                // אם הנתונים בענן חדשים יותר
                if (cloudTime > (lastSyncTime ? lastSyncTime.getTime() : 0)) {
                    loadDataFromCloud(cloudData);
                }
            }
            
            // שמירה לענן
            localStorage.setItem(cloudKey, JSON.stringify(currentData));
            localStorage.setItem(`${cloudKey}_modified`, currentTime.toString());
            
            lastSyncTime = new Date();
        }

        function getAllUserData() {
            return {
                tasks: tasks,
                stats: { completedTasks, currentStreak, totalPoints },
                journal: journalEntries,
                pomodoro: { pomodoroCount, totalFocusTime },
                settings: notificationSettings,
                dailyStats: dailyStats,
                timestamp: Date.now()
            };
        }

        function loadDataFromCloud(cloudData) {
            if (!cloudData) return;
            
            // עדכון הנתונים המקומיים
            if (cloudData.tasks) tasks = cloudData.tasks;
            if (cloudData.stats) {
                completedTasks = cloudData.stats.completedTasks || 0;
                currentStreak = cloudData.stats.currentStreak || 0;
                totalPoints = cloudData.stats.totalPoints || 0;
            }
            if (cloudData.journal) journalEntries = cloudData.journal;
            if (cloudData.pomodoro) {
                pomodoroCount = cloudData.pomodoro.pomodoroCount || 0;
                totalFocusTime = cloudData.pomodoro.totalFocusTime || 0;
            }
            if (cloudData.settings) notificationSettings = cloudData.settings;
            if (cloudData.dailyStats) dailyStats = cloudData.dailyStats;
            
            // עדכון התצוגה
            updateStats();
            renderTasks();
            updateProgress();
            displayJournalHistory();
            updatePomodoroStats();
            updateAdvancedStats();
            
            // שמירה מקומית
            saveAllLocalData();
        }

        function saveToCloudStorage() {
            if (!syncEnabled || !syncUser) return;
            
            const userData = getAllUserData();
            const cloudKey = `procrastination_data_${syncUser}`;
            
            localStorage.setItem(cloudKey, JSON.stringify(userData));
            localStorage.setItem(`${cloudKey}_modified`, Date.now().toString());
        }

        function loadFromCloudStorage() {
            if (!syncEnabled || !syncUser) return;
            
            const cloudKey = `procrastination_data_${syncUser}`;
            const cloudData = localStorage.getItem(cloudKey);
            
            if (cloudData) {
                try {
                    const parsedData = JSON.parse(cloudData);
                    loadDataFromCloud(parsedData);
                } catch (error) {
                    console.error('Error loading cloud data:', error);
                }
            }
        }

        function saveAllLocalData() {
            localStorage.setItem('procrastination_tasks', JSON.stringify(tasks));
            localStorage.setItem('procrastination_stats', JSON.stringify({
                completedTasks,
                currentStreak,
                totalPoints
            }));
            localStorage.setItem('journal_entries', JSON.stringify(journalEntries));
            localStorage.setItem('pomodoro_stats', JSON.stringify({
                pomodoroCount,
                totalFocusTime
            }));
            localStorage.setItem('notification_settings', JSON.stringify(notificationSettings));
            localStorage.setItem('daily_stats', JSON.stringify(dailyStats));
        }

        function loadSyncSettings() {
            const savedUser = localStorage.getItem('sync_user');
            const savedEnabled = localStorage.getItem('sync_enabled');
            
            if (savedUser && savedEnabled === 'true') {
                syncUser = savedUser;
                syncEnabled = true;
                
                document.getElementById('userEmail').value = savedUser;
                updateSyncStatus('online', 'מחובר');
                updateSyncButtons(true);
                
                startAutoSync();
            }
        }

        // פונקציה מעודכנת להתחלת עבודה
        const originalStartPomodoro = startPomodoro;
        startPomodoro = function() {
            workStartTime = new Date();
            const workTimeInput = document.getElementById('workTime');
            pomodoroTime = parseInt(workTimeInput.value) * 60;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('timerMode').textContent = 'עבודה...';
            
            pomodoroTimer = setInterval(() => {
                if (!isPomodoroPaused) {
                    pomodoroTime--;
                    updateTimerDisplay();
                    
                    if (pomodoroTime <= 0) {
                        clearInterval(pomodoroTimer);
                        pomodoroCount++;
                        totalFocusTime += parseInt(workTimeInput.value);
                        
                        // רישום פומודורו שהושלם
                        recordPomodoroCompletion();
                        
                        updatePomodoroStats();
                        
                        if (notificationSettings.enabled) {
                            showNotification('🎉 פומודורו הושלם!', 'זמן להפסקה - עשית עבודה מעולה!');
                        } else {
                            alert('🎉 פומודורו הושלם! זמן להפסקה');
                        }
                        resetPomodoro();
                    }
                }
            }, 1000);
            
            if (notificationSettings.enabled) {
                showNotification('פומודורו התחיל!', 'זמן לעבודה מרוכזת. בהצלחה!');
            }
        };

        // משתנים יומן
        let selectedMoodToday = null;
        let selectedReasons = [];
        let journalEntries = [];

        // משתנים הישגים
        let currentLevel = 1;
        let currentXP = 0;
        let totalHours = 0;
        let activeStreak = 0;
        let bestStreak = 0;
        let dailyStats = JSON.parse(localStorage.getItem('daily_stats') || '{}');
        let weeklyData = [];

        // פונקציות גרפים וסטטיסטיקות
        function updateDailyStats() {
            const today = new Date().toDateString();
            if (!dailyStats[today]) {
                dailyStats[today] = {
                    tasksCompleted: 0,
                    pomodoroCount: 0,
                    workTime: 0,
                    createdTasks: 0,
                    timestamps: []
                };
            }
            
            dailyStats[today].tasksCompleted = tasks.filter(t => t.completed && 
                new Date(t.completedAt || t.createdAt).toDateString() === today).length;
            
            localStorage.setItem('daily_stats', JSON.stringify(dailyStats));
        }

        function drawWeeklyChart() {
            const canvas = document.getElementById('weeklyChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const last7Days = getLast7Days();
            
            // נקה את הקנבס
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // הגדרות
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const maxTasks = Math.max(...last7Days.map(d => d.tasks), 1);
            
            // רקע
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.fillRect(padding, padding, chartWidth, chartHeight);
            
            // קווי רשת
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // עמודות
            const barWidth = chartWidth / 7;
            last7Days.forEach((day, index) => {
                const barHeight = (day.tasks / maxTasks) * chartHeight;
                const x = padding + index * barWidth + barWidth * 0.1;
                const y = padding + chartHeight - barHeight;
                
                // עמודה
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#4CAF50');
                gradient.addColorStop(1, '#45a049');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth * 0.8, barHeight);
                
                // מספר משימות
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(day.tasks.toString(), x + barWidth * 0.4, y - 5);
                
                // יום
                ctx.fillText(day.dayName, x + barWidth * 0.4, padding + chartHeight + 20);
            });
            
            // כותרת
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('משימות שהושלמו השבוע', canvas.width / 2, 25);
        }

        function getLast7Days() {
            const days = [];
            const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const dayData = dailyStats[dateStr] || { tasksCompleted: 0, pomodoroCount: 0 };
                
                days.push({
                    date: dateStr,
                    dayName: dayNames[date.getDay()],
                    tasks: dayData.tasksCompleted || 0,
                    pomodoro: dayData.pomodoroCount || 0
                });
            }
            
            return days;
        }

        function updateAdvancedStats() {
            // חישוב סטטיסטיקות מתקדמות
            const allDays = Object.keys(dailyStats);
            const totalDays = allDays.length;
            
            if (totalDays > 0) {
                const totalTasks = allDays.reduce((sum, day) => sum + (dailyStats[day].tasksCompleted || 0), 0);
                const avgTasksPerDay = (totalTasks / totalDays).toFixed(1);
                document.getElementById('avgTasksPerDay').textContent = avgTasksPerDay;
                
                // אחוז השלמה
                const totalCreated = allDays.reduce((sum, day) => sum + (dailyStats[day].createdTasks || 0), 0);
                const completionRate = totalCreated > 0 ? ((totalTasks / totalCreated) * 100).toFixed(0) : 0;
                document.getElementById('completionRate').textContent = `${completionRate}%`;
            }
            
            // עדכון גרפים
            setTimeout(() => {
                drawWeeklyChart();
                drawPomodoroChart();
            }, 100);
        }

        function drawPomodoroChart() {
            const canvas = document.getElementById('pomodoroChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const last7Days = getLast7Days();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const maxPomodoro = Math.max(...last7Days.map(d => d.pomodoro), 1);
            
            // רקע
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.fillRect(padding, padding, chartWidth, chartHeight);
            
            // קו גרף
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            last7Days.forEach((day, index) => {
                const x = padding + (index / 6) * chartWidth;
                const y = padding + chartHeight - (day.pomodoro / maxPomodoro) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // נקודות
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // מספרים
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(day.pomodoro.toString(), x, y - 10);
                ctx.fillText(day.dayName, x, padding + chartHeight + 20);
            });
            
            ctx.stroke();
            
            // כותרת
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('פומודורו השבוע', canvas.width / 2, 25);
        }

        // משפטי מוטיבציה
        const motivationQuotes = [
            "הדרך הטובה ביותר להתחיל היא להפסיק לדבר ולהתחיל לעשות",
            "אתה לא צריך להיות נהדר כדי להתחיל, אבל אתה צריך להתחיל כדי להיות נהדר",
            "הרגל קטן שנעשה כל יום עדיף מתוכנית גדולה שלא מבוצעת",
            "האתגר הגדול ביותר שלך הוא לשכנע את עצמך שאתה יכול",
            "הצלחה היא סך של מאמצים קטנים שחוזרים על עצמם יום אחר יום",
            "כל מומחה היה פעם מתחיל. כל מקצוען היה פעם חובב. כל סמל היה פעם טירון",
            "הדבר הקשה ביותר זה להתחיל. ברגע שתתחיל - המשך יבוא מעצמו",
            "אל תחכה לרגע המושלם. קח את הרגע ועשה אותו מושלם",
            "הסיבה שרוב האנשים לא מגיעים למטרות שלהם היא שהם לא מגדירים אותן",
            "בכל פעם שאתה דוחה את מה שחשוב, אתה בוחר במה שלא חשוב"
        ];

        // שאלות בדיקת דחיינות
        const quizQuestions = [
            {
                question: "כמה פעמים בשבוע אתה דוחה משימות חשובות?",
                options: ["כמעט אף פעם", "פעם-פעמיים בשבוע", "מספר פעמים בשבוע", "כמעט כל יום"]
            },
            {
                question: "איך אתה מרגיש כשיש לך משימה גדולה לעשות?",
                options: ["מתרגש להתחיל", "קצת לחוץ אבל מתמודד", "מוצף ולא יודע איך להתחיל", "מתעלם מהמשימה לגמרי"]
            },
            {
                question: "מה קורה בדרך כלל כשיש לך דדליין?",
                options: ["מסיים הרבה לפני הזמן", "מסיים בזמן", "מסיים ברגע האחרון", "לא מספיק להסיים בזמן"]
            },
            {
                question: "איך אתה מתמודד עם משימות משעממות?",
                options: ["עושה אותן מיד כדי להסיר מהראש", "מוצא דרכים לעשות אותן מעניינות", "דוחה אותן כמה שיותר", "כמעט לא עושה אותן"]
            }
        ];

        // פונקציות עזר
        function showTab(tabName) {
            // הסתר כל הטאבים
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // הסתר כל הכפתורים
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // הצג הטאב הנבחר
            document.getElementById(tabName).classList.add('active');
            
            // סמן את הכפתור הנבחר
            const activeBtn = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function goHome() {
            showTab('motivation');
            // גלילה לראש הדף
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // עדכון תפריט תחתון
            setActiveBottomNav(document.querySelector('.bottom-nav-btn'));
            // ויברציה קלה
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function setActiveBottomNav(activeBtn) {
            // הסר פעיל מכל הכפתורים
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => 
                btn.classList.remove('active'));
            // הוסף פעיל לכפתור הנוכחי
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            // ויברציה קלה
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        function newMotivation() {
            const randomQuote = motivationQuotes[Math.floor(Math.random() * motivationQuotes.length)];
            document.getElementById('motivationText').textContent = randomQuote;
            
            // אנימציה
            const card = document.querySelector('.motivation-card');
            card.style.transform = 'scale(1.05)';
            setTimeout(() => {
                card.style.transform = 'scale(1)';
            }, 200);
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const taskText = input.value.trim();
            
            if (taskText === '') return;
            
            const task = {
                id: Date.now(),
                text: taskText,
                completed: false,
                createdAt: new Date()
            };
            
            tasks.push(task);
            input.value = '';
            renderTasks();
            updateProgress();
        }

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <span>${task.text}</span>
                    <div>
                        ${!task.completed ? `<button class="complete-btn" onclick="completeTask(${task.id})">✅ השלם</button>` : ''}
                        <button class="delete-btn" onclick="deleteTask(${task.id})">🗑️ מחק</button>
                    </div>
                `;
                taskList.appendChild(li);
            });
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = true;
                task.completedAt = new Date().toISOString();
                completedTasks++;
                totalPoints += 10;
                
                // ויברציה להצלחה
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                recordTaskCompletion();
                updateStats();
                renderTasks();
                updateProgress();
                
                // אפקט חזותי
                const taskElements = document.querySelectorAll('.task-item');
                taskElements.forEach(element => {
                    const taskText = element.querySelector('span').textContent;
                    if (taskText === task.text) {
                        element.style.transform = 'scale(1.1)';
                        element.style.background = '#d4edda';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                            renderTasks(); // רענון התצוגה
                        }, 300);
                    }
                });
                
                // התראה של הצלחה
                if (notificationSettings.enabled) {
                    showNotification('משימה הושלמה! 🎉', `"${task.text}" - קיבלת 10 נקודות!`);
                }
            }
        }

        function deleteTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            renderTasks();
            updateProgress();
        }

        function updateProgress() {
            const completedToday = tasks.filter(t => t.completed).length;
            const totalToday = tasks.length;
            const percentage = totalToday > 0 ? (completedToday / totalToday) * 100 : 0;
            
            document.getElementById('dailyProgress').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${Math.round(percentage)}% הושלם היום`;
        }

        function updateStats() {
            document.getElementById('tasksCompleted').textContent = completedTasks;
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('totalPoints').textContent = totalPoints;
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                addTask();
            }
        }

        // פונקציות חידון
        function selectOption(optionIndex) {
            // הסר בחירה קודמת
            document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
            
            // סמן בחירה חדשה
            event.target.classList.add('selected');
            
            // שמור ציון
            quizScore += optionIndex;
            
            setTimeout(() => {
                nextQuestion();
            }, 1000);
        }

        function nextQuestion() {
            currentQuizQuestion++;
            
            if (currentQuizQuestion < quizQuestions.length) {
                displayQuestion();
            } else {
                showQuizResult();
            }
        }

        function displayQuestion() {
            const question = quizQuestions[currentQuizQuestion];
            document.getElementById('quizQuestion').textContent = question.question;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionDiv);
            });
        }

        function showQuizResult() {
            const resultContainer = document.getElementById('quizResult');
            let resultText = '';
            let resultClass = '';
            
            if (quizScore <= 4) {
                resultText = '🎉 מעולה! רמת הדחיינות שלך נמוכה. המשך כך!';
                resultClass = 'success';
            } else if (quizScore <= 8) {
                resultText = '⚠️ יש לך נטייה מתונה לדחיינות. המערכת יכולה לעזור לך!';
                resultClass = 'warning';
            } else {
                resultText = '🚨 רמת הדחיינות שלך גבוהה. זמן לשינוי! התחל עם המערכת שלנו.';
                resultClass = 'danger';
            }
            
            resultContainer.innerHTML = resultText;
            resultContainer.style.display = 'block';
            resultContainer.className = `quiz-result ${resultClass}`;
            
            // הסתר את השאלות
            document.getElementById('quizQuestion').style.display = 'none';
            document.getElementById('quizOptions').style.display = 'none';
            
            // כפתור התחלה מחדש
            setTimeout(() => {
                const restartBtn = document.createElement('button');
                restartBtn.textContent = '🔄 התחל מחדש';
                restartBtn.className = 'motivation-btn';
                restartBtn.onclick = restartQuiz;
                resultContainer.appendChild(restartBtn);
            }, 2000);
        }

        function restartQuiz() {
            currentQuizQuestion = 0;
            quizScore = 0;
            
            document.getElementById('quizQuestion').style.display = 'block';
            document.getElementById('quizOptions').style.display = 'grid';
            document.getElementById('quizResult').style.display = 'none';
            
            displayQuestion();
        }

        // אתחול המערכת
        window.onload = function() {
            updateStats();
            displayQuestion();
            updateTimerDisplay();
            
            // טעינת נתונים שמורים
            const savedTasks = localStorage.getItem('procrastination_tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
                renderTasks();
                updateProgress();
            }
            
            const savedStats = localStorage.getItem('procrastination_stats');
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                completedTasks = stats.completedTasks || 0;
                currentStreak = stats.currentStreak || 0;
                totalPoints = stats.totalPoints || 0;
                updateStats();
            }
            
            const savedJournal = localStorage.getItem('journal_entries');
            if (savedJournal) {
                journalEntries = JSON.parse(savedJournal);
                displayJournalHistory();
            }
            
            const savedPomodoro = localStorage.getItem('pomodoro_stats');
            if (savedPomodoro) {
                const pomodoroStats = JSON.parse(savedPomodoro);
                pomodoroCount = pomodoroStats.pomodoroCount || 0;
                totalFocusTime = pomodoroStats.totalFocusTime || 0;
                updatePomodoroStats();
            }
            
            // PWA Setup
            initializePWA();
            
            // טעינת הגדרות
            loadNotificationSettings();
            
            // טעינת עיצוב שמור
            const savedTheme = localStorage.getItem('selected_theme');
            if (savedTheme) {
                document.getElementById('colorTheme').value = savedTheme;
                changeTheme();
            }
            
            const savedFontSize = localStorage.getItem('selected_font_size');
            if (savedFontSize) {
                document.getElementById('fontSize').value = savedFontSize;
                changeFontSize();
            }
            
            // עדכון סטטיסטיקות מתקדמות
            updateDailyStats();
            updateAdvancedStats();
            
            // טעינת הגדרות סנכרון
            loadSyncSettings();
            
            // אתחול Firebase (אם זמין)
            initializeFirebase();
            
            // הוספת מאזיני קלידה למקשי קיצור
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // הוספת מאזין גלילה לכפתור חזרה למעלה
            window.addEventListener('scroll', handleScroll);
        };

        // פונקציות גלילה
        function handleScroll() {
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            if (window.pageYOffset > 300) {
                scrollTopBtn.classList.add('visible');
            } else {
                scrollTopBtn.classList.remove('visible');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // מקשי קיצור
        function handleKeyboardShortcuts(event) {
            // רק אם לא בתוך שדה קלט
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Alt + מספר למעבר בין טאבים
            if (event.altKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        showTab('motivation');
                        setActiveBottomNav(document.querySelector('.bottom-nav-btn:nth-child(1)'));
                        break;
                    case '2':
                        event.preventDefault();
                        showTab('progress');
                        setActiveBottomNav(document.querySelector('.bottom-nav-btn:nth-child(2)'));
                        break;
                    case '3':
                        event.preventDefault();
                        showTab('pomodoro');
                        setActiveBottomNav(document.querySelector('.bottom-nav-btn:nth-child(3)'));
                        break;
                    case '4':
                        event.preventDefault();
                        showTab('achievements');
                        setActiveBottomNav(document.querySelector('.bottom-nav-btn:nth-child(4)'));
                        break;
                    case '5':
                        event.preventDefault();
                        showTab('settings');
                        setActiveBottomNav(document.querySelector('.bottom-nav-btn:nth-child(5)'));
                        break;
                }
            }
            
            // מקשים נוספים
            switch(event.key) {
                case 'h':
                case 'H':
                    if (!event.ctrlKey && !event.altKey) {
                        event.preventDefault();
                        goHome();
                    }
                    break;
                case 'Enter':
                    // אם בטאב משימות ולא בתוך שדה
                    if (document.getElementById('progress').classList.contains('active') && 
                        !event.target.closest('input')) {
                        event.preventDefault();
                        addTask();
                    }
                    break;
                case ' ':
                    // רווח להפעלת/השהיית פומודורו
                    if (document.getElementById('pomodoro').classList.contains('active')) {
                        event.preventDefault();
                        const startBtn = document.getElementById('startBtn');
                        const pauseBtn = document.getElementById('pauseBtn');
                        if (startBtn.style.display !== 'none') {
                            startPomodoro();
                        } else if (pauseBtn.style.display !== 'none') {
                            pausePomodoro();
                        }
                    }
                    break;
                case 'Escape':
                    // ESC לחזרה לדף הבית
                    event.preventDefault();
                    goHome();
                    break;
            }
        }

        // PWA Variables
        let deferredPrompt;
        let isInstalled = false;

        // PWA Functions
        function initializePWA() {
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            }

            // Listen for install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });

            // Check if already installed
            window.addEventListener('appinstalled', () => {
                hideInstallButton();
                isInstalled = true;
            });

            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                hideInstallButton();
                isInstalled = true;
            }
        }

        function showInstallButton() {
            const installBtn = document.getElementById('installBtn');
            if (installBtn && !isInstalled) {
                installBtn.style.display = 'block';
            }
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        hideInstallButton();
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Mobile optimizations
        document.addEventListener('DOMContentLoaded', function() {
            // 🌐 אתחול ספק ענן
            initializeCloudProvider();
            
            // 💾 אתחול מערכת גיבוי
            setTimeout(() => {
                updateAutoBackupStatus();
            }, 2000);
            
            // Prevent zoom on input focus for iOS
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth < 768) {
                        const viewport = document.querySelector('meta[name="viewport"]');
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
                
                input.addEventListener('blur', function() {
                    if (window.innerWidth < 768) {
                        const viewport = document.querySelector('meta[name="viewport"]');
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
                    }
                });
            });

            // Handle mobile keyboard
            if (window.innerWidth < 768) {
                window.addEventListener('resize', function() {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                });
            }
        });

        // 🌐 אתחול ספק ענן
        async function initializeCloudProvider() {
            try {
                // עדכון בחירה בממשק
                const select = document.getElementById('cloudProvider');
                if (select) {
                    select.value = currentCloudProvider;
                }
                
                console.log(`🌐 מאתחל ספק ענן: ${currentCloudProvider}`);
                
                // אתחול בהתאם לספק הנבחר
                if (currentCloudProvider === 'supabase') {
                    if (window.supabaseManager) {
                        await window.supabaseManager.initialize();
                        updateCloudStatus('✅ Supabase מוכן');
                    } else {
                        updateCloudStatus('⚠️ Supabase לא זמין');
                    }
                } else if (currentCloudProvider === 'firebase') {
                    // Firebase מאותחל בקוד הקיים
                    updateCloudStatus('✅ Firebase מוכן');
                } else {
                    updateCloudStatus('💾 מצב מקומי בלבד');
                }
                
                // בדיקת חיבור אוטומטית
                setTimeout(() => {
                    testCloudConnection();
                }, 2000);
                
            } catch (error) {
                console.error('שגיאה באתחול ספק ענן:', error);
                updateCloudStatus('❌ שגיאה באתחול');
            }
        }

        // שמירת נתונים
        function saveData() {
            localStorage.setItem('procrastination_tasks', JSON.stringify(tasks));
            localStorage.setItem('procrastination_stats', JSON.stringify({
                completedTasks,
                currentStreak,
                totalPoints
            }));
        }

        // פונקציות פומודורו
        function startPomodoro() {
            const workTimeInput = document.getElementById('workTime');
            pomodoroTime = parseInt(workTimeInput.value) * 60;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('timerMode').textContent = 'עבודה...';
            
            pomodoroTimer = setInterval(() => {
                if (!isPomodoroPaused) {
                    pomodoroTime--;
                    updateTimerDisplay();
                    
                    if (pomodoroTime <= 0) {
                        clearInterval(pomodoroTimer);
                        pomodoroCount++;
                        totalFocusTime += parseInt(workTimeInput.value);
                        updatePomodoroStats();
                        
                        alert('🎉 פומודורו הושלם! זמן להפסקה');
                        resetPomodoro();
                    }
                }
            }, 1000);
        }
        
        function pausePomodoro() {
            isPomodoroPaused = !isPomodoroPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = isPomodoroPaused ? '▶️ המשך' : '⏸️ השהה';
        }
        
        function resetPomodoro() {
            clearInterval(pomodoroTimer);
            pomodoroTime = 25 * 60;
            isPomodoroPaused = false;
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('pauseBtn').textContent = '⏸️ השהה';
            document.getElementById('timerMode').textContent = 'מוכן להתחלה';
            
            updateTimerDisplay();
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(pomodoroTime / 60);
            const seconds = pomodoroTime % 60;
            document.getElementById('timerText').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function updatePomodoroStats() {
            document.getElementById('pomodoroCount').textContent = pomodoroCount;
            document.getElementById('totalFocusTime').textContent = totalFocusTime;
        }
        
        // פונקציות יומן
        function selectMood(emoji, description) {
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            selectedMoodToday = { emoji, description };
            document.getElementById('selectedMood').textContent = `${emoji} ${description}`;
        }
        
        function toggleReason(button, reason) {
            button.classList.toggle('selected');
            if (button.classList.contains('selected')) {
                selectedReasons.push(reason);
            } else {
                selectedReasons = selectedReasons.filter(r => r !== reason);
            }
        }
        
        function saveJournalEntry() {
            const journalText = document.getElementById('journalText').value;
            
            if (!selectedMoodToday && selectedReasons.length === 0 && !journalText.trim()) {
                alert('אנא בחר לפחות מצב רוח או כתוב משהו ביומן');
                return;
            }
            
            const entry = {
                date: new Date().toLocaleDateString('he-IL'),
                mood: selectedMoodToday,
                reasons: [...selectedReasons],
                text: journalText,
                timestamp: Date.now()
            };
            
            journalEntries.unshift(entry);
            localStorage.setItem('journal_entries', JSON.stringify(journalEntries));
            
            // איפוס הטופס
            document.getElementById('journalText').value = '';
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.reason-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('selectedMood').textContent = '';
            selectedMoodToday = null;
            selectedReasons = [];
            
            displayJournalHistory();
            alert('הרשומה נשמרה בהצלחה! 📝');
            
            // סנכרון אוטומטי
            if (syncEnabled) {
                setTimeout(() => saveToCloudStorage(), 1000);
            }
        }
        
        function displayJournalHistory() {
            const historyContainer = document.getElementById('journalHistory');
            historyContainer.innerHTML = '';
            
            journalEntries.slice(0, 5).forEach(entry => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'journal-record';
                recordDiv.innerHTML = `
                    <div class="journal-date">${entry.date}</div>
                    ${entry.mood ? `<div class="journal-mood">מצב רוח: ${entry.mood.emoji} ${entry.mood.description}</div>` : ''}
                    ${entry.reasons.length > 0 ? `<div class="journal-reasons">סיבות לדחיינות: ${entry.reasons.join(', ')}</div>` : ''}
                    ${entry.text ? `<div class="journal-text">${entry.text}</div>` : ''}
                `;
                historyContainer.appendChild(recordDiv);
            });
        }

        // עדכון הפונקציות לשמור נתונים
        const originalCompleteTask = completeTask;
        completeTask = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completedAt = new Date().toISOString();
                recordTaskCompletion();
            }
            originalCompleteTask(taskId);
            updateAdvancedStats();
            
            // סנכרון אוטומטי
            if (syncEnabled) {
                setTimeout(() => saveToCloudStorage(), 1000);
            }
        };

        const originalDeleteTask = deleteTask;
        deleteTask = function(taskId) {
            originalDeleteTask(taskId);
            updateDailyStats();
            
            // סנכרון אוטומטי
            if (syncEnabled) {
                setTimeout(() => saveToCloudStorage(), 1000);
            }
        };

        const originalAddTask = addTask;
        addTask = function() {
            originalAddTask();
            recordTaskCreation();
            
            // סנכרון אוטומטי
            if (syncEnabled) {
                setTimeout(() => saveToCloudStorage(), 1000);
            }
        };

        function recordTaskCompletion() {
            const today = new Date().toDateString();
            if (!dailyStats[today]) {
                dailyStats[today] = {
                    tasksCompleted: 0,
                    pomodoroCount: 0,
                    workTime: 0,
                    createdTasks: 0,
                    timestamps: []
                };
            }
            
            dailyStats[today].timestamps = dailyStats[today].timestamps || [];
            dailyStats[today].timestamps.push(Date.now());
            
            updateDailyStats();
        }

        function recordTaskCreation() {
            const today = new Date().toDateString();
            if (!dailyStats[today]) {
                dailyStats[today] = {
                    tasksCompleted: 0,
                    pomodoroCount: 0,
                    workTime: 0,
                    createdTasks: 0,
                    timestamps: []
                };
            }
            
            dailyStats[today].createdTasks = (dailyStats[today].createdTasks || 0) + 1;
            localStorage.setItem('daily_stats', JSON.stringify(dailyStats));
        }

        function recordPomodoroCompletion() {
            const today = new Date().toDateString();
            if (!dailyStats[today]) {
                dailyStats[today] = {
                    tasksCompleted: 0,
                    pomodoroCount: 0,
                    workTime: 0,
                    createdTasks: 0,
                    timestamps: []
                };
            }
            
            dailyStats[today].pomodoroCount = (dailyStats[today].pomodoroCount || 0) + 1;
            localStorage.setItem('daily_stats', JSON.stringify(dailyStats));
            updateAdvancedStats();
        }
    </script>
</body>
</html>